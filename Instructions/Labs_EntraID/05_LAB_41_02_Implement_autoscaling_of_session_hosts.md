---
lab:
  title: '랩: 세션 호스트의 자동 크기 조정 구현'
  module: 'Module 4.1: Monitor and manage Azure Virtual Desktop services'
---

# 랩 - 세션 호스트의 자동 크기 조정 구현 및 모니터링
# 학생용 랩 매뉴얼

## 랩 종속성

- 이 랩에서 사용할 Azure 구독
- 이 랩에서 사용할 Azure 구독에 대한 Owner 또는 Contributor 역할, 그리고 해당 Azure 구독에 연결된 Microsoft Entra 테넌트에 디바이스를 연결하기에 충분한 사용 권한이 설정되어 있는 Entra 계정
- *Azure Portal을 사용하여 호스트 풀 및 세션 호스트 배포(Entra ID)* 랩 완료
- *Azure Portal을 사용하여 호스트 풀 및 세션 호스트 관리(Entra ID)* 랩 완료
- 랩 *세션 호스트(Entra ID)에 연결*이 완료되었습니다.

## 예상 소요 시간

45분

## 랩 시나리오

정기적으로 사용량이 변경되는 Azure Virtual Desktop 환경이 있습니다. 자동 크기 조정 계획 기능을 활용하여 비용을 최소화하려고 합니다.

## 목표
  
이 랩을 완료하면 다음을 수행할 수 있습니다.

- Azure Virtual Desktop 자동 크기 조정 구현 및 평가

## 랩 파일

- None

## 지침

### 연습 1: Azure Virtual Desktop 자동 크기 조정 계획 구현
  
이 연습의 주요 작업은 다음과 같습니다.

1. Azure Virtual Desktop 서비스 주체에 필요한 RBAC 역할 할당
1. 모든 세션 호스트 중지 및 할당 취소
1. 호스트 풀 설정 조정
1. 크기 조정 계획 만들기
1. 자동 크기 조정 기능 평가
1. 호스트 풀 자동 크기 조정 사용 안 함

#### 작업 1: Azure Virtual Desktop 서비스 주체에 필요한 RBAC 역할 할당

> **참고**: 자동 크기 조정 계획이 작동하려면 Azure Virtual Desktop 서비스 주체에게 세션 호스트 VM의 전원 상태를 관리할 수 있는 권한을 부여해야 합니다. 이러한 권한은 기본 제공 **데스크톱 가상화 전원 켜기 끄기 기여자** RBAC 역할을 사용하여 부여할 수 있습니다. 역할 할당은 구독 범위에서 수행되어야 한다는 점을 명심해야 합니다. 리소스 그룹, 호스트 풀 또는 VM과 같이 구독보다 낮은 수준에서 이 역할을 할당하면 자동 크기 조정이 제대로 작동하지 않습니다. 

> **참고**: 이 역할은 *Azure Portal(Entra ID)을 사용하여 호스트 풀 및 세션 호스트 관리* 랩에서 사용된 역할(**데스크톱 가상화 전원 켜기 기여자**)과 다릅니다. 이 역할은 *연결 시 VM 시작* 기능을 지원하는 데 필요했습니다.

1. 필요한 경우 랩 컴퓨터에서 웹 브라우저를 시작하고 Azure Portal로 이동한 뒤, 이 랩에서 사용할 구독에서 Owner 역할이 있는 사용자 계정의 자격 증명을 입력하여 로그인합니다.

    > **참고**: 랩 세션 창 오른쪽에 있는 리소스 탭의 목록에 있는 `User1-` 계정의 자격 증명을 사용합니다.

1. 랩 컴퓨터에서 Azure Portal이 표시된 웹 브라우저를 열고 Azure Cloud Shell에서 PowerShell 세션을 시작합니다.

    > **참고**: 메시지가 표시되면 **시작** 창의 **구독** 드롭다운 목록에서 이 랩에서 사용 중인 Azure 구독의 이름을 선택한 다음 **적용**을 선택합니다.

1. Azure Cloud Shell 창의 PowerShell 세션에서 다음 명령을 실행하여 이 랩에서 사용 중인 Azure 구독의 Id 속성 값을 검색하여 `$subId` 변수에 저장합니다.

    ```powershell
    $subId = (Get-AzSubscription).Id
    ```

1. 다음 명령을 실행하여 $parameters 변수를 만듭니다. 이 변수에는 RBAC 역할 정의 이름, **Azure Virtual Desktop** 서비스 주체를 나타내는 Microsoft Entra 애플리케이션, 구독 범위의 값이 포함된 해시 테이블이 저장됩니다.

    ```powershell
    $parameters = @{
        RoleDefinitionName = "Desktop Virtualization Power On Off Contributor"
        ApplicationId = "9cdead84-a844-4324-93f2-b2e6bb768d07"
        Scope = "/subscriptions/$subId"
    }
    ```

1. RBAC 역할 할당을 만들려면 다음 명령을 실행합니다.

    ```powershell
    New-AzRoleAssignment @parameters
    ```

1. Cloud Shell 창을 닫습니다.

#### 작업 2: 모든 세션 호스트 중지 및 할당 취소

> **참고**: 자동 크기 조정 기능을 평가하려면 Azure Virtual Desktop 환경에서 모든 세션 호스트를 중지하고 할당을 취소합니다. 

1. 랩 컴퓨터의 Azure Portal이 표시된 웹 브라우저에서 **Azure Virtual Desktop**을 검색하여 선택하고, **Azure Virtual Desktop** 페이지에서 세로 메뉴 모음의 **관리** 섹션에서 **호스트 풀**을 선택합니다.
1. **Azure Virtual Desktop \| 호스트 풀** 페이지의 호스트 풀 목록에서 **az140-21-hp1**을 선택합니다.
1. **az140-21-hp1** 페이지의 세로 메뉴 모음에 있는 **관리** 섹션에서 **세션 호스트**를 선택합니다.
1. **az140-21-hp1 \|세션 호스트** 페이지에서 각 세션 호스트 이름 옆에 있는 확인란을 선택한 다음 **중지**를 선택합니다.
1. 확인 메시지가 표시되면 **세션 호스트 중지** 팝업 창에서 **중지**를 선택합니다.

    > **참고**: **중지** 버튼을 표시하려면 도구 모음에서 줄임표(`...`) 아이콘을 선택해야 할 수도 있습니다.

    > **참고**: 세션 호스트가 중지되고 할당 취소될 때까지 기다리지 말고 대신 다음 작업을 진행합니다. 세션 호스트를 중지하고 할당 취소하는 데 약 2분이 걸릴 수 있습니다.

#### 작업 3: 호스트 풀 설정 조정

> **참고**: 풀링된 호스트 풀에 대해 자동 크기 조정을 사용하는 경우 해당 호스트 풀에 대해 구성된 MaxSessionLimit 매개 변수가 있어야 합니다. 이 랩에서는 자동 크기 조정 기능을 쉽게 보여 줄 수 있도록 인위적으로 낮게 설정합니다.

1. 랩 컴퓨터의 Azure Portal을 표시하는 웹 브라우저에서 **az140-21-hp1** 페이지의 **설정** 섹션에서 **속성**을 선택합니다.
1. **az140-21-hp1\|속성** 페이지에서 **최대 세션 제한** 텍스트 상자에 **1**을 입력합니다.
1. **az140-21-hp1\|속성** 페이지에서 **저장**을 선택합니다.

#### 작업 4: 크기 조정 계획 만들기

1. 랩 컴퓨터의 Azure Portal을 표시하는 웹 브라우저에서 **Azure Virtual Desktop**을 검색하여 선택하고, **Azure Virtual Desktop** 페이지의 세로 탐색 메뉴의 **관리** 섹션에서 **크기 조정 계획**을 선택합니다.
1. **Azure Virtual Desktop \| 크기 조정 계획**페이지에서 **+ 만들기**를 선택합니다.
1. **크기 조정 계획 만들기** 페이지의 **기본** 탭에서 다음 설정을 지정하고 **다음: 일정**을 선택합니다.

    |설정|값|
    |---|---|
    |구독|이 랩에서 사용 중인 Azure 구독의 이름|
    |Resource group|새 리소스 그룹 **az140-412e-RG**의 이름|
    |그기 조정 계획 이름|**az140-scalingplan412e**|
    |지역|Azure Virtual Desktop 환경을 배포한 Azure 지역의 이름|
    |식별 이름|**az140-scalingplan412e**|
    |표준 시간대|Azure Virtual Desktop 환경을 배포한 Azure 지역의 현지 표준 시간대|
    |호스트 풀 유형|**풀링됨**|

    > **참고**: **제외 태그** 속성을 설정하지 않은 상태로 둡니다. 일반적으로 이 기능을 사용하여 태그를 임의로 설정한 Azure VM을 자동 크기 조정에서 제외할 수 있습니다.

1. **일정** 탭에서 **+ 일정 추가**를 선택합니다.

    > **참고**: 일정을 사용하면 평일에 대해 램프 업 시간, 피크 시간, 램프 다운 시간 및 사용량이 적은 시간을 정의하고 자동 크기 조정 트리거를 지정할 수 있습니다. 크기 조정 계획에는 일주일 중 적어도 하루에 대한 관련 일정이 포함되어야 합니다. 

1. **일정 추가** 창의 **일반** 탭에서 다음 설정과 일치하도록 기본 구성을 조정한 다음, **다음**을 선택합니다.

    |설정|값|
    |---|---|
    |표준 시간대|Azure Virtual Desktop 환경의 현지 표준 시간대(이 작업의 앞부분에서 선택한 지역 기반)|
    |일정 이름|**week_schedule**|
    |반복|**7개 선택됨**(모든 요일 선택)|

    > **참고**: 일정은 요일마다 효과적으로 적용되므로 자동 크기 조정 결과를 쉽게 평가할 수 있습니다.

1. **일정 추가** 창의 **램프 업** 탭에서 다음 설정과 일치하도록 기본 구성을 조정한 다음, **다음**을 선택합니다.

    |설정|값|
    |---|---|
    |시작 시간(12시간 시스템)|현재 시간에서 1시간을 뺀 시간|
    |부하 분산 알고리즘|**너비 우선**|
    |호스트의 최소 백분율(%)|**30**|
    |용량 임계값(%)|**60**|

    > **참고**: 풀링된 호스트 풀의 경우 자동 크기 조정은 호스트 풀 설정의 기존 부하 분산 알고리즘을 무시하고 대신 일정 구성에 따라 부하 분산을 적용합니다.

    > **참고**: **호스트의 최소 백분율** 설정은 램프 업 및 사용량이 많은 시간에 시작할 세션 호스트 가상 머신의 최소 비율을 지정합니다. 예를 들어 **최소 호스트 비율**이 30%로 지정되고 호스트 풀에 있는 세션 호스트의 총 수가 3개이면 자동 크기 조정은 최소 1개의 세션 호스트가 사용자 연결을 허용할 수 있도록 합니다.

    > **참고**: 자동 크기 조정은 가장 가까운 정수로 반올림됩니다.

    > **참고**: **용량 임계값** 설정은 램프 업 및 사용량이 많은 시간 동안 가상 머신을 켜거나 끌지 여부를 평가할 때 고려할 사용된 호스트 풀 용량의 백분율입니다. 예를 들어 용량 임계값이 60%로 지정되고 호스트 풀 용량이 1개 세션(호스트 1개 실행 중)인 경우, 호스트 풀의 부하가 60%를 초과하면(이 경우 100%) 자동 크기 조정 기능이 추가 세션 호스트를 켭니다.

1. **일정 추가** 창의 **사용량이 많은 시간** 탭에서 다음 설정과 일치하도록 기본 구성을 조정한 후 **다음**을 선택합니다.

    |설정|값|
    |---|---|
    |시작 시간(12시간 시스템)|현재 시간에 1시간을 더한 시간|
    |부하 분산 알고리즘|**깊이 우선**|
    |용량 임계값(%)|**60**|

    > **참고**: **용량 임계값(%)** 설정은 **램프 업** 및 **사용량이 많은 시간** 설정 사이에서 공유됩니다.

1. **일정 추가** 창의 **램프 다운** 탭에서 다음 설정과 일치하도록 기본 구성을 조정한 후 **다음**을 선택합니다.

    |설정|값|
    |---|---|
    |시작 시간(12시간 시스템)|현재 시간에 2시간을 더한 시간|
    |부하 분산 알고리즘|**깊이 우선**|
    |활성 호스트의 최소 백분율(%)|**10**|
    |용량 임계값(%)|**80**|
    |사용자 강제 로그오프|**No**|
    |다음과 같은 경우 VM을 중지합니다.|**VM에 활성 또는 연결이 끊긴 세션이 없습니다.**|

    > **참고**: **활성 호스트의 최소 백분율(%)** 설정은 램프 다운 및 사용량이 적은 시간에 접근하려는 세션 호스트 가상 머신의 최소 비율을 지정합니다. 예를 들어 **활성 호스트의 최소 백분율(%)** 이 10%로 설정되어 있고 호스트 풀에 있는 세션 호스트의 총 수가 3개이면 자동 크기 조정은 최소 1개의 세션 호스트가 사용자 연결을 수행할 수 있도록 합니다.

    > **참고**: **용량 임계값(%)** 설정은 램프 다운 및 사용량이 적은 시간 동안 가상 머신을 끌지 여부를 평가할 때 고려할 호스트 풀 용량의 비율을 지정합니다. 예를 들어 사용자 연결 1개와 호스트 3개가 실행 중일 때 용량 임계값이 80%로 지정되면 자동 크기 조정은 호스트 1개를 끕니다(결과적으로 호스트 풀 용량의 50%가 사용됨).

    > **참고**: 일반적으로 자동 크기 조정은 다음 규칙에 따라 세션 호스트를 중지하고 할당을 취소합니다.

    - 사용된 호스트 풀 용량이 용량 임계값 미만입니다.
    - 세션 호스트를 끄면 용량 임계값을 초과하지 않습니다.
    - 자동 크기 조정 기능은 크기 조정 계획이 램프 다운 단계에 있고 사용자 로그오프를 강제하는 설정을 활성화한 경우가 아니면 사용자 세션이 없는 세션 호스트만 끕니다. 
    - 풀링된 자동 크기 조정은 사용자 환경에 영향을 미치지 않도록 램프 업 단계에서 세션 호스트를 끄지 않습니다.

1. **일정 추가** 창의 **사용량이 적은 시간** 탭에서 다음 설정과 일치하도록 기본 구성을 조정한 후 **추가**를 선택합니다.

    |설정|값|
    |---|---|
    |시작 시간(12시간 시스템)|현재 시간에 3시간을 더한 시간|
    |부하 분산 알고리즘|**깊이 우선**|
    |용량 임계값(%)|**80**|

    > **참고**: **용량 임계값** 설정은 **램프 다운** 및 **사용량이 낮은 시간** 설정 간에 공유됩니다.

1. **크기 조정 계획 만들기** 페이지의 **일정** 탭으로 돌아가서 **다음: 호스트 풀 할당**을 선택합니다.
1. **호스트 풀 할당** 탭에서, **호스트 풀 선택** 드롭다운 목록에서 **az140-21-hp1**을 선택하고, **자동 크기 조정 사용** 확인란이 선택되어 있는지 확인한 후, **검토 + 만들기**를 선택합니다.
1. **검토 + 만들기** 창에서 **만들기**를 선택합니다.

    > **참고**: 자동 크기 조정 구성이 완료되기를 기다립니다. 이 작업은 일반적으로 몇 초 정도 걸립니다.

#### 작업 5: 자동 크기 조정 기능 평가

> **참고**: **램프 업** 설정을 평가하여 시작합니다.

1. 랩 컴퓨터의 Azure Portal이 표시된 웹 브라우저에서 **Azure Virtual Desktop**을 검색하여 선택하고, **Azure Virtual Desktop** 페이지에서 세로 메뉴 모음의 **관리** 섹션에서 **호스트 풀**을 선택합니다.
1. **Azure Virtual Desktop \| 호스트 풀** 페이지의 호스트 풀 목록에서 **az140-21-hp1**을 선택합니다.
1. **az140-21-hp1** 페이지의 세로 메뉴 모음에 있는 **관리** 섹션에서 **세션 호스트**를 선택합니다.
1. **az140-21-hp1 \| 세션 호스트** 페이지에서 세션 호스트의 **전원 상태** 설정의 값을 검토하고 그 중 하나가 **실행 중**으로 나열되어 있는지 확인합니다.

    > **참고**: 첫 번째 세션 호스트가 **실행 중** 상태에 도달하기까지 몇 분 정도 기다려야 할 수 있습니다.

    > **참고**: 이는 예상되는 것으로, 새로 만든 크기 조정 계획의 **램프 업** 설정에 따라 하나 이상의 세션 호스트가 항상 온라인 상태여야 하기 때문입니다. 이 시점에서 호스트 풀 용량은 1(실행 중인 호스트가 1개뿐이므로)이지만, 사용자 연결이 없으므로 사용된 호스트 풀 용량은 0%입니다.

    > **참고**: 다음으로 단일 사용자 세션을 시작하여 **램프 업** 및 **피킹 시간** 용량 임계값 설정을 평가합니다. 두 단계가 동일한 용량 임계값을 공유하므로 **피킹 시간** 범위를 벗어나도 이를 평가할 수 있습니다.

1. 랩 컴퓨터에서 Microsoft 원격 데스크톱 클라이언트를 시작합니다.
1. 랩 컴퓨터의 **원격 데스크톱** 클라이언트 창에서 **구독**을 선택하고 메시지가 표시되면, 랩 인터페이스 창의 오른쪽 창에 있는 **리소스** 탭에서 찾을 수 있는 `User2` Entra ID 사용자 계정의 자격 증명으로 로그인합니다.
1. **원격 데스크톱** 페이지에 Microsoft Word, Microsoft Excel, Microsoft PowerPoint 및 명령 프롬프트를 포함한 4개의 아이콘이 표시되는지 확인합니다. 
1. 명령 프롬프트 아이콘을 두 번 클릭합니다. 
1. 로그인하라는 메시지가 표시되면 **Windows 보안** 대화 상자에서 대상 Azure Virtual Desktop 환경에 연결하는 데 사용한 Microsoft Entra 사용자 계정의 암호를 입력합니다.
1. 명령 프롬프트** 창이 **곧 표시되는지 확인합니다. 

    > **참고**: 이 시점에서 사용된 호스트 풀 용량은 이제 용량 임계값(60%)보다 큰 100%입니다. 이로 인해 다른 호스트가 자동으로 크기 조정되어 사용된 호스트 풀 용량이 50%로 설정됩니다. 이는 용량 임계값보다 낮으므로 세 번째 호스트는 중지/할당 취소된 상태로 유지됩니다. 다음에 이를 확인합니다.

1. 랩 컴퓨터에서 Azure Portal을 표시하는 웹 브라우저 창으로 전환합니다. 
1. **az140-21-hp1 \| 세션 호스트** 페이지에서 **새로 고침**을 선택하고, 세션 호스트의 **전원 상태** 설정 값을 검토하고, 이제 두 개의 세션 호스트가 **실행 중**으로 나열되었는지 확인합니다.

    > **참고**: 다음으로, 해당 시간 범위를 조정하여 **램프 다운** 용량 임계값 설정을 평가합니다. 

1. **az140-21-hp1 \| 세션 호스트** 페이지의 세로 탐색 메뉴의 **설정** 섹션에서 **크기 조정 계획**을 선택한 다음, **크기 조정 계획** 페이지에서 **az140-scalingplan412e**를 선택합니다.
1. **az140-scalingplan412e** 페이지의 세로 탐색 메뉴의 **설정** 섹션에서 **일정**을 선택한 다음 **week_schedule**을 선택합니다.
1. **week_schedule** 창에서 **램프 다운** 탭으로 이동하여 **시작 시간(12시간 시스템)** 설정의 값을 **피킹 시간** 단계의 **시작 시간(12시간 시스템)** 과 현재 시간 사이의 시간으로 조정합니다.

    > **참고**: **피킹 시간** 단계의 **시작 시간(12시간 시스템)** 값을 조정해야 할 수 있습니다.

1. **week_schedule** 창에서 **피킹 해제 시간** 탭으로 이동하고 **저장**을 선택합니다.
1. 호스트 풀에 대한 유일한 RDP 세션을 나타내는 **명령 프롬프트** 창으로 전환하고 명령 프롬프트에서 다음을 입력하고 **Enter** 키를 누릅니다.

    ```cmd
    logoff
    ```

1. 랩 컴퓨터의 Azure Portal이 표시된 웹 브라우저에서 **Azure Virtual Desktop**을 검색하여 선택하고, **Azure Virtual Desktop** 페이지에서 세로 메뉴 모음의 **관리** 섹션에서 **호스트 풀**을 선택합니다.
1. **Azure Virtual Desktop \| 호스트 풀** 페이지의 호스트 풀 목록에서 **az140-21-hp1**을 선택합니다.
1. **az140-21-hp1** 페이지의 세로 메뉴 모음에 있는 **관리** 섹션에서 **세션 호스트**를 선택합니다.
1. **az140-21-hp1 \| 세션 호스트** 페이지에서 세션 호스트의 **전원 상태** 설정 값을 검토하고 이제 그 중 하나만 **실행 중**으로 나열되었는지 확인합니다.

#### 작업 6: 호스트 풀 자동 크기 조정 사용 중지하기

> **참고**: 자동 크기 조정 구성이 다른 랩에 영향을 미치지 않도록 이 랩에서 구현한 크기 조정 계획의 호스트 풀 할당을 제거할 것입니다.

1. 랩 컴퓨터의 Azure Portal을 표시하는 웹 브라우저에서 **Azure Virtual Desktop**을 검색하여 선택하고, **Azure Virtual Desktop** 페이지의 세로 탐색 메뉴의 **관리** 섹션에서 **크기 조정 계획**을 선택한 다음, **크기 조정 계획** 페이지에서 **az140-scalingplan412e**를 선택합니다.
1. **az140-scalingplan412e** 페이지의 **관리** 섹션에서 **호스트 풀 할당**을 선택합니다.
1. **az140-scalingplan412e \| 호스트 풀 할당** 페이지에서 **az140-21-hp1**을 선택한 다음, 할당** 취소**를 선택하고 확인하라는 메시지가 표시되면 **호스트 풀 할당 취소** 대화 상자에서 **할당 취소**를 선택합니다.